!function(){"use strict";var t=function(){this.currentLine=null,this.lineTemplate=null,this.homeTemplate=null,this.settingsTemplate=null,this.mainArea=document.getElementById(this.mainPageID),this.init()};t.prototype={mainPageID:"main-body",bodyView:{home:"homepage",line:"line",settings:"settings"},selectors:{mainPage:'[data-js="main-body"]',lineBox:'[data-js="linebox"]',lineBoxAlert:'[data-js="linebox-alert"]',lineBoxSummary:'[data-js="linebox-summary"]',notificationsPanel:'[data-js="notifications-panel"]',notificationsSave:'[data-js="notifications-save"]',notificationsStatus:'[data-js="notifications-progress"]'},paths:{data:"/all.json",home:"/",line:"/bakerloo-line",settings:"/settings"},storage:{allLines:"allLines"},sessionData:{},updateInterval:12e4,database:null,safeResponse:function(t){return t.status>=200&&t.status<400},ajax:function(t,e,i){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onload=function(){return this.safeResponse(n)?e(n.response):i?i(n.response):void 0}.bind(this),n.onerror=function(){return i?i(n.response):void 0},n.send()},getDatabaseTable:function(){var t=this.database?this.database.transaction(["data"],"readwrite"):null;return t?t.objectStore("data"):null},setData:function(t,e,i){var n,s;this.sessionData[t]=e,n=this.getDatabaseTable(),n?(s=n.put(e,t),s.onsuccess=function(){i&&i()}):i&&i()},getData:function(t,e){var i;return this.sessionData[t]?e?e(this.sessionData[t]):this.sessionData[t]:(i=this.getDatabaseTable(),void(i&&(i.get(t).onsuccess=function(i){var n=i.target.result;this.sessionData[t]=n,e&&e(n)}.bind(this))))},initWithDB:function(){var t=indexedDB.open("TubeLines",1);t.onsuccess=function(t){this.database=t.target.result,this.getData(this.storage.allLines,function(t){var e,i;t&&window.TubeAlert.linedata?(t=JSON.parse(t),e=new Date(t.lines[0].latestStatus.updatedAt),i=new Date(window.TubeAlert.linedata[0].latestStatus.updatedAt),i>e&&this.setData(this.storage.allLines,JSON.stringify({lines:window.TubeAlert.linedata}))):window.TubeAlert.linedata&&this.setData(this.storage.allLines,JSON.stringify({lines:window.TubeAlert.linedata})),this.updateState()}.bind(this)),this.refreshData(),setInterval(this.refreshData.bind(this),this.updateInterval),"serviceWorker"in navigator&&"content"in document.createElement("template")&&navigator.serviceWorker.register("/service-worker.js",{scope:"/"}).then(this.initialiseServiceWorker.bind(this))}.bind(this),t.onupgradeneeded=function(t){var e=t.target.result;t.oldVersion<1&&e.createObjectStore("data")}.bind(this)},init:function(){return this.getTemplates(),this.addListeners(),window.indexedDB?this.initWithDB():(window.TubeAlert.linedata&&this.setData(this.storage.allLines,JSON.stringify({lines:window.TubeAlert.linedata})),this.refreshData(),void setInterval(this.refreshData.bind(this),this.updateInterval))},updateState:function(){var t,e,i,n,s,a=document.querySelectorAll(this.selectors.lineBox),o=a.length;for(s=0;o>s;s++)t=a[s],e=this.getLineData(t.dataset.linebox),e&&(i=new Date(t.dataset.updated),n=new Date(e.latestStatus.updatedAt),n>i&&(t.dataset.updated=e.latestStatus.updatedAt,t.querySelector(this.selectors.lineBoxSummary).textContent=e.statusSummary,e.isDisrupted?t.querySelector(this.selectors.lineBoxAlert).classList.remove("hidden"):t.querySelector(this.selectors.lineBoxAlert).classList.add("hidden"),this.currentLine==e.urlKey&&(this.swapBody(this.transformLineTemplate(this.lineTemplate,e)),this.setNotificationsPanel(e.urlKey))))},initialiseServiceWorker:function(){this.currentLine&&this.setNotificationsPanel(this.currentLine)},stringToDom:function(t){var e=document.createElement("div");return e.innerHTML=t,e},getTemplates:function(){var t=document.body,e=document.getElementById(this.mainPageID).cloneNode(!0);this.currentLine=null,t.dataset.view==this.bodyView.home?this.homeTemplate=e:this.ajax(this.paths.home,function(t){this.homeTemplate=this.stringToDom(t).querySelector(this.selectors.mainPage)}.bind(this)),t.dataset.view==this.bodyView.line?(this.lineTemplate=e,this.currentLine=t.dataset.pageline):this.ajax(this.paths.line,function(t){this.lineTemplate=this.stringToDom(t).querySelector(this.selectors.mainPage)}.bind(this)),t.dataset.view==this.bodyView.settings?this.settingsTemplate=e:this.ajax(this.paths.settings,function(t){this.settingsTemplate=this.stringToDom(t).querySelector(this.selectors.mainPage)}.bind(this))},refreshData:function(){this.ajax(this.paths.data,function(t){this.setData(this.storage.allLines,t,this.updateState.bind(this))}.bind(this))},swapBody:function(t){this.mainArea.innerHTML=t.innerHTML},goHome:function(t){var e="/",i=document.body;return this.homeTemplate?(this.swapBody(this.homeTemplate),document.body.dataset.view=this.bodyView.home,i.dataset.pageline=null,this.currentLine=null,void(t||window.history.pushState({},"",e))):void(window.location.href=e)},goToSettings:function(t){var e="/settings",i=document.body;return this.settingsTemplate?(this.swapBody(this.settingsTemplate),i.dataset.view=this.bodyView.settings,i.dataset.pageline=null,this.currentLine=null,void(t||window.history.pushState({},"",e))):void(window.location.href=e)},goToLine:function(t,e){var i="/"+t,n=this.getLineData(t),s=document.body;return this.lineTemplate&&n?(this.swapBody(this.transformLineTemplate(this.lineTemplate,n)),this.setNotificationsPanel(t),s.dataset.view=this.bodyView.line,s.dataset.pageline=t,this.currentLine=t,void(e||window.history.pushState({},"",i))):void(window.location.href=i)},setNotificationsPanel:function(t){var e=document.querySelector(this.selectors.notificationsPanel),i=document.querySelector(this.selectors.notificationsSave),n=document.getElementById("template-notify"),s=document.importNode(n.content,!0);if("showNotification"in ServiceWorkerRegistration.prototype&&"PushManager"in window){if("denied"===Notification.permission)return void(e.innerHTML="You have denied access for notifications");i.disabled=!1,i.addEventListener("click",function(){i.disabled=!0,this.updateSubscription(t,s)}.bind(this)),this.getData("times",function(i){i&&(i=JSON.parse(i),i[t]&&(s=this.setTimes(JSON.parse(i[t]),s))),e.innerHTML="",e.appendChild(s)}.bind(this))}},setTimes:function(t,e){var i,n,s=t.length;for(i=0;s>i;i++)n=e.querySelector('input[value="'+t[i]+'"]'),n&&(n.checked=!0);return e},updateStatus:function(t){var e=document.querySelector(this.selectors.notificationsStatus);e.innerHTML=t},updateSubscription:function(t,e){var i=e.querySelectorAll('[type="checkbox"]'),n=document.querySelector(this.selectors.notificationsSave),s=(i.length,JSON.stringify(this.getTimes()));this.updateStatus('<span class="loading loading--leading"></span>Saving...'),this.getData("times",function(e){e=e?JSON.parse(e):{},e[t]=s,this.setData("times",JSON.stringify(e))}.bind(this)),navigator.serviceWorker.ready.then(function(t){t.pushManager.subscribe({userVisibleOnly:!0}).then(function(t){var e="/notifications/subscribe?endpoint="+t.endpoint+"&line="+this.currentLine;n.disabled=!1,e+="&times="+s,this.ajax(e,function(t){var e=JSON.parse(t);return e.status&&"ok"===e.status?void this.updateStatus("Saved"):void this.updateStatus("An error occurred")}.bind(this),function(){this.updateStatus("An error occurred")}.bind(this))}.bind(this))["catch"](function(t){"denied"===Notification.permission?(this.updateStatus("Permission denied"),n.disabled=!1):(this.updateStatus("Unable to subscribe"),n.disabled=!1)}.bind(this))}.bind(this))},getTimes:function(){var t,e,i=document.querySelector(this.selectors.notificationsPanel),n=i.querySelectorAll('[type="checkbox"]'),s=n.length,a=[];for(t=0;s>t;t++)e=n[t],e.checked&&a.push(e.value);return a},transformLineTemplate:function(t,e){var i=this.stringToDom(t.innerHTML),n=i.querySelector('[data-js="line-title"]'),s=i.querySelector('[data-js="line-status-panel"]'),a=i.querySelector('[data-js="line-updated"]'),o="<h2>No information</h2>",r="N/A";return i.querySelector('[data-js="notifyHead"]').dataset.linebox=e.urlKey,n.dataset.linebox=e.urlKey,n.innerHTML=e.name,e.latestStatus&&(o='<h2 class="g-unit">'+e.latestStatus.title+"</h2>",e.latestStatus.isDisrupted&&e.latestStatus.descriptions&&e.latestStatus.descriptions.forEach(function(t){o+='<p class="g-unit">'+t+"</p>"}),r=e.latestStatus.updatedAtFormatted),s.innerHTML=o,a.innerHTML=r,i},getLineData:function(t){var e,i=this.getData(this.storage.allLines),n=null;return i?(e=JSON.parse(i),e&&e.lines?(e.lines.forEach(function(e){e.urlKey==t&&(n=e)}),n):null):null},navigate:function(t,e){return"/"==t?this.goHome(e):"/settings"==t?this.goToSettings(e):(t=t.replace("/",""),this.goToLine(t,e))},addListeners:function(){document.body.addEventListener("click",function(t){for(var e=t.target;e!=document.body&&"a"!=e.tagName.toLowerCase();)e=e.parentNode;e.hostname&&e.hostname==window.location.hostname&&(t.preventDefault(),this.navigate(e.pathname))}.bind(this)),window.onpopstate=function(){this.navigate(document.location.pathname,!0)}.bind(this)}},document.querySelector&&document.addEventListener&&window.history&&new t}();